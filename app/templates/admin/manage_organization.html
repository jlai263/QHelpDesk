{% extends "base.html" %}

{% block app_content %}
{% if error_message %}
    <div class="alert alert-danger">
        <i class="fas fa-exclamation-circle"></i> {{ error_message }}
        <a href="{{ url_for('main.index') }}" class="btn btn-default btn-sm pull-right">
            <i class="fas fa-home"></i> Return to Home
        </a>
    </div>
{% elif not organization %}
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle"></i> Organization not found or you don't have access.
        <a href="{{ url_for('main.index') }}" class="btn btn-default btn-sm pull-right">
            <i class="fas fa-home"></i> Return to Home
        </a>
    </div>
{% else %}
<div class="container-fluid px-4" style="padding-top: 8rem;">
    <div class="row">
        <div class="col-12">
            <div class="page-header">
                <h1>
                    <i class="fas fa-building"></i> {{ organization.name }}
                    <small class="text-muted">@{{ organization.domain }}</small>
                </h1>
            </div>

            <!-- Organization Stats -->
            <div class="row stats-row">
                <div class="col-md-3">
                    <div class="stat-box">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-number">{{ members|length }}</div>
                            <div class="stat-label">Members</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box">
                        <div class="stat-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-number">{{ pending_invites|length }}</div>
                            <div class="stat-label">Pending Invites</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Members Section -->
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        Members
                        <button class="btn btn-primary btn-sm invite-member-btn" data-toggle="modal" data-target="#inviteModal">
                            <i class="fas fa-user-plus"></i> Invite Member
                        </button>
                    </h3>
                </div>
                <div class="panel-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Joined</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for member in members %}
                                <tr>
                                    <td>{{ member.username }}</td>
                                    <td>{{ member.email }}</td>
                                    <td>
                                        <span class="label {% if member.role == 'admin' %}label-danger{% else %}label-info{% endif %}">
                                            {{ member.role|title }}
                                        </span>
                                    </td>
                                    <td>{{ member.created_at.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        {% if current_user.id != member.id and member.role != 'admin' %}
                                        <button class="btn btn-default btn-sm edit-role-btn" data-toggle="modal" 
                                                data-target="#editRoleModal" 
                                                data-userid="{{ member.id }}"
                                                data-username="{{ member.username }}"
                                                data-role="{{ member.role }}">
                                            <i class="fas fa-user-edit"></i> Edit Role
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Pending Invitations Section -->
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Pending Invitations</h3>
                </div>
                <div class="panel-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Sent</th>
                                    <th>Expires</th>
                                    <th>Token</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for invite in pending_invites %}
                                <tr {% if invite.is_expired() %}class="text-muted"{% endif %}>
                                    <td>{{ invite.email }}</td>
                                    <td>
                                        <span class="label {% if invite.is_admin_invite %}label-danger{% else %}label-info{% endif %}">
                                            {{ 'Admin' if invite.is_admin_invite else 'User' }}
                                        </span>
                                    </td>
                                    <td>{{ invite.created_at.strftime('%Y-%m-%d') }}</td>
                                    <td>{{ invite.expires_at.strftime('%Y-%m-%d') }}</td>
                                    <td><code>{{ invite.token }}</code></td>
                                    <td>
                                        <form action="{{ url_for('admin.cancel_invite', token=invite.token) }}" method="POST" style="display: inline;">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="fas fa-times"></i> Cancel
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center">No pending invites</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Current Subscription -->
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Current Subscription</h3>
                </div>
                <div class="panel-body">
                    {% if organization.subscription_plan %}
                        <div class="row">
                            <div class="col-md-6">
                                <h4>{{ organization.subscription_plan.name }} Plan</h4>
                                <p class="text-muted">{{ organization.subscription_plan.description }}</p>
                                <p><strong>Price:</strong> ${{ "%.2f"|format(organization.subscription_plan.price) }}/month</p>
                                <p><strong>Team Size Limit:</strong> {% if organization.subscription_plan.name == 'Enterprise' %}Unlimited{% else %}{{ organization.subscription_plan.team_size_limit }}{% endif %} members</p>
                                <p><strong>Current Team Size:</strong> {{ members|length }} members</p>
                                <p><strong>Remaining Seats:</strong> {% if organization.subscription_plan.name == 'Enterprise' %}Unlimited{% else %}{{ organization.subscription_plan.team_size_limit - members|length }}{% endif %} seats</p>
                                {% if organization.current_subscription %}
                                    <p><strong>Status:</strong> 
                                        <span class="label {% if organization.current_subscription.status == 'active' %}label-success{% elif organization.current_subscription.status == 'cancelled' %}label-warning{% else %}label-default{% endif %}">
                                            {{ organization.current_subscription.status|title }}
                                        </span>
                                    </p>
                                    {% if organization.current_subscription.next_billing_date %}
                                        <p><strong>Next Payment:</strong> {{ organization.current_subscription.next_billing_date.strftime('%B %d, %Y') }}</p>
                                    {% endif %}
                                    {% if organization.current_subscription.end_date %}
                                        <p><strong>Active Until:</strong> {{ organization.current_subscription.end_date.strftime('%B %d, %Y') }}</p>
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i> Your subscription will automatically switch to the Free plan after this date.
                                        </div>
                                    {% endif %}
                                    {% if organization.subscription_plan.price > 0 %}
                                        <div class="subscription-actions mt-3">
                                            <form action="{{ url_for('admin.cancel_subscription') }}" method="post" style="display: inline;">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <button type="submit" class="btn btn-danger">
                                                    <i class="fas fa-times-circle"></i> Cancel Subscription
                                                </button>
                                            </form>
                                            {% set free_plan = subscription_plans|selectattr('price', 'equalto', 0)|first %}
                                            {% if free_plan %}
                                                <form action="{{ url_for('admin.change_plan', plan_id=free_plan.id) }}" method="post" style="display: inline-block; margin-left: 10px;">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                    <button type="submit" class="btn btn-secondary">
                                                        <i class="fas fa-exchange-alt"></i> Switch to Free Plan
                                                    </button>
                                                </form>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <h5>Features:</h5>
                                <ul class="list-unstyled">
                                    {% for feature in organization.subscription_plan.features %}
                                        <li><i class="fas fa-check text-success"></i> {{ feature }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    {% else %}
                        <p class="text-muted">No active subscription. Please select a plan below.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Available Plans -->
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Available Plans</h3>
                </div>
                <div class="panel-body">
                    <div class="row">
                        {% for plan in subscription_plans %}
                            <div class="col-md-4">
                                <div class="card h-100 {% if organization.subscription_plan and organization.subscription_plan.id == plan.id %}border-primary{% endif %}">
                                    <div class="card-header">
                                        <h5 class="mb-0">{{ plan.name }}</h5>
                                    </div>
                                    <div class="card-body">
                                        <h3 class="text-center mb-4">${{ "%.2f"|format(plan.price) }}<small class="text-muted">/month</small></h3>
                                        <p class="text-muted">{{ plan.description }}</p>
                                        <ul class="list-unstyled">
                                            {% for feature in plan.features %}
                                                <li><i class="fas fa-check text-success"></i> {{ feature }}</li>
                                            {% endfor %}
                                        </ul>
                                        <p><strong>Team Size:</strong> {% if plan.name == 'Enterprise' %}Unlimited{% else %}Up to {{ plan.team_size_limit }} members{% endif %}</p>
                                    </div>
                                    <div class="card-footer text-center">
                                        {% if organization.subscription_plan and organization.subscription_plan.id == plan.id %}
                                            <button class="btn btn-success" disabled>Current Plan</button>
                                        {% else %}
                                            {% if plan.price > 0 %}
                                                <div class="stripe-payment-container">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                    <button type="button" class="btn btn-primary subscribe-button" 
                                                            data-plan-name="{{ plan.name }}"
                                                            data-plan-price="{{ plan.price }}"
                                                            data-plan-id="{{ plan.id }}">
                                                        Subscribe for ${{ "%.2f"|format(plan.price) }}/month
                                                    </button>
                                                </div>
                                            {% else %}
                                                <form action="{{ url_for('admin.change_plan', plan_id=plan.id) }}" method="post">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                    <button type="submit" class="btn btn-primary">
                                                        {% if organization.subscription_plan and organization.subscription_plan.price > 0 %}
                                                            Switch to Free Plan
                                                        {% else %}
                                                            Select Free Plan
                                                        {% endif %}
                                                    </button>
                                                </form>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Invite Modal -->
            <div class="modal fade" id="inviteModal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">Invite New Member</h4>
                        </div>
                        <form action="{{ url_for('admin.invite_user') }}" method="POST" id="inviteForm">
                            <div class="modal-body">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <div class="form-group">
                                    <label for="emailPrefix">Email Address</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="emailPrefix" name="email_prefix" required>
                                        <span class="input-group-addon">@{{ organization.domain }}</span>
                                        <input type="hidden" name="email" id="fullEmail">
                                    </div>
                                    <div id="emailError" class="text-danger" style="display: none;"></div>
                                </div>
                                <div class="form-group">
                                    <label>Role</label>
                                    <div class="radio">
                                        <label>
                                            <input type="radio" name="role" value="user" checked>
                                            Regular User (can create and manage their own tickets)
                                        </label>
                                    </div>
                                    <div class="radio">
                                        <label>
                                            <input type="radio" name="role" value="staff">
                                            Staff (can manage all tickets)
                                        </label>
                                    </div>
                                    <div class="radio">
                                        <label>
                                            <input type="radio" name="role" value="admin">
                                            Admin (can manage organization and all features)
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary">Send Invitation</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Edit Role Modal -->
            <div class="modal fade" id="editRoleModal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">Edit Member Role</h4>
                        </div>
                        <form id="editRoleForm" method="POST">
                            <div class="modal-body">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <p>Update role for <strong id="editUsername"></strong></p>
                                <div class="form-group">
                                    <div class="radio">
                                        <label>
                                            <input type="radio" name="role" value="user" required>
                                            Regular User (can create and manage their own tickets)
                                        </label>
                                    </div>
                                    <div class="radio">
                                        <label>
                                            <input type="radio" name="role" value="staff" required>
                                            Staff (can manage all tickets)
                                        </label>
                                    </div>
                                    <div class="radio">
                                        <label>
                                            <input type="radio" name="role" value="admin" required>
                                            Admin (can manage organization and all features)
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </div>
                        </form>
                        
                <form action="" method="POST" id="removeMemberForm" style="display: inline;">
                    <div class="modal-footer" style="border-top: none;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to remove this member from the organization?');">
                            <i class="fas fa-user-minus"></i> Remove from Organization
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
/* Base styles */
body {
    min-height: 100vh;
    padding-top: 0;
}

/* Container styles */
.container-fluid {
    width: 100%;
    margin-right: auto;
    margin-left: auto;
}

.px-4 {
    padding-left: 1.5rem !important;
    padding-right: 1.5rem !important;
}

/* Stats row */
.stats-row {
    margin: 0 -0.75rem 30px;
}

.stat-box {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    margin-bottom: 20px;
}

.stat-icon {
    font-size: 2em;
    color: #007bff;
    margin-right: 20px;
}

.stat-info {
    flex-grow: 1;
}

.stat-number {
    font-size: 1.5em;
    font-weight: bold;
    color: #2c3e50;
}

.stat-label {
    color: #6c757d;
}

/* Panel styles */
.panel {
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.panel-heading {
    background: linear-gradient(135deg, #0062cc, #0096ff);
    color: white;
    border: none;
    padding: 15px;
    border-radius: 8px 8px 0 0;
}

.panel-title {
    margin: 0;
    font-size: 1.2em;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: white !important;
}

.panel-title h3,
.panel-title span {
    color: white !important;
}

/* Button styles */
.btn-primary {
    background-color: #007bff;
    border-color: #0056b3;
    transition: all 0.2s ease;
    display: inline-block !important;
}

.invite-member-btn {
    display: inline-block !important;
    position: relative;
    transition: all 0.2s ease;
}

.invite-member-btn:hover {
    background-color: #0069d9;
    border-color: #0056b3;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.invite-member-btn:active,
.invite-member-btn:focus {
    background-color: #007bff !important;
    border-color: #0056b3 !important;
    transform: translateY(0);
    box-shadow: none !important;
    outline: none !important;
}

/* Keep invite button visible when modal is open */
.modal.in ~ .panel .invite-member-btn,
.modal.show ~ .panel .invite-member-btn,
.modal.fade ~ .panel .invite-member-btn,
.modal-open .invite-member-btn {
    display: inline-block !important;
    opacity: 1 !important;
    visibility: visible !important;
}

.btn-default {
    background-color: #f8f9fa;
    border-color: #ddd;
    color: #333;
}

.btn-default:hover {
    background-color: #e9ecef;
    border-color: #ddd;
    color: #333;
}

.edit-role-btn {
    display: inline-block !important;
    position: relative;
    transition: all 0.2s ease;
}

.edit-role-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.edit-role-btn:active,
.edit-role-btn:focus {
    background-color: #f8f9fa !important;
    border-color: #ddd !important;
    color: #333 !important;
    transform: translateY(0);
    box-shadow: none !important;
    outline: none !important;
}

/* Remove focus and active states from all buttons */
.btn:focus, 
.btn.focus,
.btn:active,
.btn.active {
    outline: none !important;
    box-shadow: none !important;
}

/* Table styles */
.table-responsive {
    border: none;
}

.table > thead > tr > th {
    border-bottom: 2px solid #0061f2;
    color: #2c3e50;
    font-weight: 600;
    padding: 12px;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.table > tbody > tr > td {
    padding: 12px;
    vertical-align: middle;
}

/* Label styles */
.label {
    padding: 5px 10px;
    font-size: 12px;
    font-weight: 500;
    border-radius: 4px;
}

.label-danger {
    background-color: #dc3545;
}

.label-info {
    background-color: #17a2b8;
}

/* Code styles */
code {
    background-color: #f8f9fa;
    color: #2c3e50;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
}

/* Modal styles */
.modal {
    padding-right: 0 !important;
}

.modal-open {
    overflow: auto !important;
    padding-right: 0 !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .container {
        padding-right: 10px;
        padding-left: 10px;
    }
    
    .stat-box {
        margin-bottom: 15px;
    }
}

/* Card styles */
.card {
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    border: 1px solid #ddd;
    height: 100%;
    position: relative;
}

.card.border-primary {
    border: 2px solid #007bff;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #eee;
    padding: 15px;
}

.card-body {
    padding: 20px;
}

.card-footer {
    background-color: #f8f9fa;
    border-top: 1px solid #eee;
    padding: 15px;
    position: relative;
    z-index: 1;
}

.list-unstyled li {
    margin-bottom: 8px;
}

.text-success {
    color: #28a745;
}

/* Add styles to prevent unwanted scrolling */
.stripe-payment-container {
    position: relative;
    display: inline-block;
    width: 100%;
}

.subscribe-button {
    position: relative;
    width: 100%;
    z-index: 1;
}

.subscribe-button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

/* Prevent text selection on buttons */
.btn {
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}
</style>

{% block scripts %}
{{ super() }}
<script src="https://js.stripe.com/v3/"></script>
<script>
// Ensure Stripe is only initialized once
let stripe;
$(document).ready(function() {
    // Initialize Stripe only if not already initialized
    if (!stripe) {
        stripe = Stripe('{{ stripe_public_key }}');
    }

    // Prevent default behavior on right click for subscription buttons
    $('.subscribe-button').on('contextmenu', function(e) {
        e.preventDefault();
        e.stopPropagation();
        return false;
    });

    // Handle subscription button clicks with improved event prevention
    $(document).off('click touchstart mousedown', '.subscribe-button').on('click touchstart mousedown', '.subscribe-button', function(e) {
        e.preventDefault();
        e.stopPropagation();
        return false;
    });

    // Handle all form submissions to prevent page jumps
    $('form').not('.stripe-payment-container form').on('submit', function(e) {
        const form = $(this);
        // Skip if the form has a file input or specific classes that need default behavior
        if (form.find('input[type="file"]').length || form.hasClass('direct-submit')) {
            return true;
        }
        
        e.preventDefault();
        
        // Get confirmation if the form has a data-confirm attribute
        const confirmMsg = form.data('confirm');
        if (confirmMsg && !confirm(confirmMsg)) {
            return false;
        }
        
        // Submit form via AJAX
        $.ajax({
            url: form.attr('action'),
            method: form.attr('method') || 'POST',
            data: form.serialize(),
            success: function(response) {
                // Refresh the page after successful submission
                window.location.reload();
            },
            error: function(xhr) {
                alert('Error submitting form. Please try again.');
            }
        });
    });

    // Handle subscription button clicks
    $(document).off('click', '.subscribe-button').on('click', '.subscribe-button', async function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const button = $(this);
        
        // Return if button is already disabled
        if (button.prop('disabled')) {
            return false;
        }
        
        // Disable the button to prevent double clicks
        button.prop('disabled', true);
        
        try {
            const response = await fetch("{{ url_for('admin.create_checkout_session') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': $('input[name="csrf_token"]').val()
                },
                body: JSON.stringify({
                    planName: button.data('plan-name'),
                    planPrice: button.data('plan-price'),
                    planId: button.data('plan-id')
                })
            });

            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }

            // Redirect to Stripe checkout
            const result = await stripe.redirectToCheckout({
                sessionId: data.id
            });

            if (result.error) {
                throw new Error(result.error.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred during payment processing: ' + error.message);
            // Re-enable the button on error
            button.prop('disabled', false);
        }
        return false;
    });

    // Clean up any lingering modal backdrops and states
    $('.modal-backdrop').remove();
    $('body').removeClass('modal-open');
    $('.btn').removeClass('active focus');
    
    // Handle invite form submission
    var inviteForm = $('#inviteForm');
    var emailPrefixInput = $('#emailPrefix');
    var fullEmailInput = $('#fullEmail');
    var emailError = $('#emailError');
    
    inviteForm.on('submit', function(e) {
        e.preventDefault();
        
        var emailPrefix = emailPrefixInput.val().trim();
        var domain = '{{ organization.domain }}';
        
        if (!emailPrefix) {
            emailError.text('Email prefix is required');
            emailError.show();
            return false;
        }
        
        // Validate email prefix format
        var emailRegex = /^[a-zA-Z0-9._%+-]+$/;
        if (!emailRegex.test(emailPrefix)) {
            emailError.text('Invalid email prefix format');
            emailError.show();
            return false;
        }
        
        var fullEmail = emailPrefix + '@' + domain;
        fullEmailInput.val(fullEmail);
        
        // Hide any previous error messages
        emailError.hide();
        
        // Submit the form
        this.submit();
    });
    
    // Handle edit role modal
    $('#editRoleModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var userId = button.data('userid');
        var username = button.data('username');
        var currentRole = button.data('role');
        
        var modal = $(this);
        var editUsername = modal.find('#editUsername');
        var editRoleForm = modal.find('#editRoleForm');
        var removeMemberForm = modal.find('#removeMemberForm');
        
        // Set the username
        editUsername.text(username);
        
        // Set the form action URLs
        editRoleForm.attr('action', "{{ url_for('admin.update_member_role', user_id=0) }}".replace('0', userId));
        removeMemberForm.attr('action', "{{ url_for('admin.remove_member', user_id=0) }}".replace('0', userId));
        
        // Check the appropriate radio button
        modal.find('input[name="role"][value="' + currentRole + '"]').prop('checked', true);
    });
    
    // Ensure invite button stays visible
    $('#inviteModal').on('show.bs.modal', function () {
        $('.invite-member-btn').show();
    });
    
    $('#inviteModal').on('hidden.bs.modal', function () {
        $('.invite-member-btn').show();
        $('.btn').removeClass('active focus');
    });
});
</script>
{% endblock %}
{% endif %}
{% endblock %} 