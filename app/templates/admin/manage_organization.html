{% extends "base.html" %}

{% block styles %}
{{ super() }}
<style>
/* Container padding */
.container-fluid {
    padding-top: 20px;
    padding-bottom: 40px;
}

.px-4 {
    padding-left: 1.5rem !important;
    padding-right: 1.5rem !important;
}

/* Stats row */
.stats-row {
    margin: 0 -0.75rem 30px;
}

.stat-box {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    margin-bottom: 20px;
}

.stat-icon {
    font-size: 2em;
    color: #007bff;
    margin-right: 20px;
}

.stat-info {
    flex-grow: 1;
}

.stat-number {
    font-size: 1.5em;
    font-weight: bold;
    color: #2c3e50;
}

.stat-label {
    color: #6c757d;
}

/* Panel styles */
.panel {
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.panel-heading {
    background: linear-gradient(135deg, #0062cc, #0096ff);
    color: white;
    border: none;
    padding: 15px;
    border-radius: 8px 8px 0 0;
}

.panel-title {
    margin: 0;
    font-size: 1.2em;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: white !important;
}

.panel-title h3,
.panel-title span {
    color: white !important;
}

/* Button styles */
.btn-primary {
    background-color: #007bff;
    border-color: #0056b3;
    transition: all 0.2s ease;
    display: inline-block !important;
}

.invite-member-btn {
    display: inline-block !important;
    position: relative;
    transition: all 0.2s ease;
}

.invite-member-btn:hover {
    background-color: #0069d9;
    border-color: #0056b3;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.invite-member-btn:active,
.invite-member-btn:focus {
    background-color: #007bff !important;
    border-color: #0056b3 !important;
    transform: translateY(0);
    box-shadow: none !important;
    outline: none !important;
}

/* Keep invite button visible when modal is open */
.modal.in ~ .panel .invite-member-btn,
.modal.show ~ .panel .invite-member-btn,
.modal.fade ~ .panel .invite-member-btn,
.modal-open .invite-member-btn {
    display: inline-block !important;
    opacity: 1 !important;
    visibility: visible !important;
}

.btn-default {
    background-color: #f8f9fa;
    border-color: #ddd;
    color: #333;
}

.btn-default:hover {
    background-color: #e9ecef;
    border-color: #ddd;
    color: #333;
}

.edit-role-btn {
    display: inline-block !important;
    position: relative;
    transition: all 0.2s ease;
}

.edit-role-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.edit-role-btn:active,
.edit-role-btn:focus {
    background-color: #f8f9fa !important;
    border-color: #ddd !important;
    color: #333 !important;
    transform: translateY(0);
    box-shadow: none !important;
    outline: none !important;
}

/* Remove focus and active states from all buttons */
.btn:focus, 
.btn.focus,
.btn:active,
.btn.active {
    outline: none !important;
    box-shadow: none !important;
}

/* Table styles */
.table-responsive {
    border: none;
}

.table > thead > tr > th {
    border-bottom: 2px solid #0061f2;
    color: #2c3e50;
    font-weight: 600;
    padding: 12px;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.table > tbody > tr > td {
    padding: 12px;
    vertical-align: middle;
}

/* Label styles */
.label {
    padding: 5px 10px;
    font-size: 12px;
    font-weight: 500;
    border-radius: 4px;
}

.label-danger {
    background-color: #dc3545;
}

.label-info {
    background-color: #17a2b8;
}

/* Code styles */
code {
    background-color: #f8f9fa;
    color: #2c3e50;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
}

/* Modal styles */
.modal {
    padding-right: 0 !important;
    overflow-y: auto;
}

.modal-open {
    overflow: auto !important;
    padding-right: 0 !important;
    margin-right: 0 !important;
}

.modal-open .modal {
    background: rgba(0, 0, 0, 0.5);
    overflow-x: hidden;
    overflow-y: auto;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .container {
        padding-right: 10px;
        padding-left: 10px;
    }
    
    .stat-box {
        margin-bottom: 15px;
    }
}

/* Card styles */
.card {
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    border: 1px solid #ddd;
    height: 100%;
    position: relative;
}

.card.border-primary {
    border: 2px solid #007bff;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #eee;
    padding: 15px;
}

.card-body {
    padding: 20px;
}

.card-footer {
    background-color: #f8f9fa;
    border-top: 1px solid #eee;
    padding: 15px;
    position: relative;
    z-index: 1;
}

.list-unstyled li {
    margin-bottom: 8px;
}

.text-success {
    color: #28a745;
}

/* Add styles to prevent unwanted scrolling */
.stripe-payment-container {
    position: relative;
    display: inline-block;
    width: 100%;
}

.subscribe-button {
    position: relative;
    width: 100%;
    z-index: 1;
}

.subscribe-button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

/* Prevent text selection on buttons */
.btn {
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

/* Add CSS to prevent scroll jumps */
.no-scroll-form {
    display: inline-block;
    margin: 0;
    padding: 0;
}

.reactivate-subscription-btn:focus {
    outline: none;
    box-shadow: none;
}

/* TEMPORARY DEBUG: Always show the Cancel button */
.cancel-subscription-container {
    position: relative;
    display: inline-block;
    width: 100%;
}

.cancel-subscription-container button {
    position: relative;
    z-index: 1000;
}

/* Keep buttons visible during modal interactions */
.reactivate-subscription-btn,
#cancelSubscriptionBtn,
.invite-member-btn {
    position: relative;
    z-index: 1;
}

/* Keep buttons visible when modal is open */
.modal.in ~ .panel .reactivate-subscription-btn,
.modal.show ~ .panel .reactivate-subscription-btn,
.modal.fade ~ .panel .reactivate-subscription-btn,
.modal-open .reactivate-subscription-btn,
.modal.in ~ .panel #cancelSubscriptionBtn,
.modal.show ~ .panel #cancelSubscriptionBtn,
.modal.fade ~ .panel #cancelSubscriptionBtn,
.modal-open #cancelSubscriptionBtn {
    display: inline-block !important;
    opacity: 1 !important;
    visibility: visible !important;
}

/* Keep the page from shifting */
html {
    overflow-y: scroll;
}

body.modal-open {
    width: 100% !important;
    padding-right: 0 !important;
    overflow-y: scroll !important;
}

/* Prevent scroll jumping */
body {
    padding-right: 0 !important;
}

body.modal-open {
    overflow: hidden;
    position: fixed;
    width: 100%;
    height: 100%;
}

.modal {
    overflow-y: auto !important;
}

.modal-open .modal {
    overflow-x: hidden;
    overflow-y: auto;
    padding-right: 0 !important;
}

.modal-backdrop {
    position: fixed;
}

/* Keep content from shifting */
.modal-content {
    margin: 30px auto;
}

/* Prevent button jumping */
.subscribe-button,
.reactivate-subscription-btn,
#cancelSubscriptionBtn {
    position: relative;
    z-index: 1;
    transform: translateZ(0);
    backface-visibility: hidden;
}

/* Remove forced visibility styles */
.modal.in ~ .panel .reactivate-subscription-btn,
.modal.show ~ .panel .reactivate-subscription-btn,
.modal.fade ~ .panel .reactivate-subscription-btn,
.modal-open .reactivate-subscription-btn,
.modal.in ~ .panel #cancelSubscriptionBtn,
.modal.show ~ .panel #cancelSubscriptionBtn,
.modal.fade ~ .panel #cancelSubscriptionBtn,
.modal-open #cancelSubscriptionBtn {
    display: inline-block;
    opacity: 1;
    visibility: visible;
}

/* Alert styles */
.alert {
    margin-bottom: 15px;
    border-radius: 8px;
    padding: 15px;
    border: 1px solid transparent;
    opacity: 1 !important;
    display: block !important;
    position: relative;
    transition: opacity 0.3s ease-in-out;
}

.alert-success {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
}

.alert-warning {
    background-color: #fff3cd;
    border-color: #ffeeba;
    color: #856404;
}

.alert-info {
    background-color: #d1ecf1;
    border-color: #bee5eb;
    color: #0c5460;
}

.alert-danger {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}

.alert i {
    margin-right: 8px;
}

.alert strong {
    font-weight: 600;
}

.alert p {
    margin: 5px 0;
}

.alert ul {
    margin: 10px 0;
    padding-left: 20px;
}

.alert .small {
    font-size: 0.85em;
    opacity: 0.8;
}

/* Subscription status alerts */
.subscription-status-alert,
.subscription-end-alert {
    margin: 15px 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.subscription-status-alert h5,
.subscription-end-alert h5 {
    margin-top: 0;
    margin-bottom: 10px;
    font-weight: 600;
}

/* Permanent subscription alerts */
.subscription-alert {
    margin-bottom: 15px !important;
    display: block !important;
    opacity: 1 !important;
    visibility: visible !important;
    transition: none !important;
    animation: none !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.subscription-alert.alert-success {
    background-color: #d4edda !important;
    border-color: #c3e6cb !important;
    color: #155724 !important;
}

.subscription-alert.alert-warning {
    background-color: #fff3cd !important;
    border-color: #ffeeba !important;
    color: #856404 !important;
}

.subscription-alert.alert-info {
    background-color: #d1ecf1 !important;
    border-color: #bee5eb !important;
    color: #0c5460 !important;
}

.subscription-alert i {
    margin-right: 8px;
}

/* Override any Bootstrap or custom alert transitions */
.subscription-alert.fade {
    transition: none !important;
    opacity: 1 !important;
}

.subscription-alert.fade.in {
    opacity: 1 !important;
}

/* Permanent alert styles */
.permanent-alert {
    display: block !important;
    opacity: 1 !important;
    visibility: visible !important;
    position: relative !important;
    margin-bottom: 15px !important;
    padding: 15px !important;
    border-radius: 8px !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
    transition: none !important;
    animation: none !important;
    pointer-events: auto !important;
}

.permanent-alert.alert-info {
    background-color: #d1ecf1 !important;
    border-color: #bee5eb !important;
    color: #0c5460 !important;
}

.permanent-alert.alert-success {
    background-color: #d4edda !important;
    border-color: #c3e6cb !important;
    color: #155724 !important;
}

.permanent-alert.alert-warning {
    background-color: #fff3cd !important;
    border-color: #ffeeba !important;
    color: #856404 !important;
}

/* Override any Bootstrap alert behaviors */
.permanent-alert.fade,
.permanent-alert.fade.in,
.permanent-alert.fade.show {
    opacity: 1 !important;
    display: block !important;
}

.permanent-alert.alert.fade.show {
    opacity: 1 !important;
}

.permanent-alert.collapsing,
.permanent-alert.collapse,
.permanent-alert.collapse.in,
.permanent-alert.collapse.show {
    display: block !important;
}
</style>
{% endblock %}

{% block app_content %}
{% if error_message %}
    <div class="alert alert-danger">
        <i class="fas fa-exclamation-circle"></i> {{ error_message }}
        <a href="{{ url_for('main.index') }}" class="btn btn-default btn-sm pull-right">
            <i class="fas fa-home"></i> Return to Home
        </a>
    </div>
{% elif not organization %}
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle"></i> Organization not found or you don't have access.
        <a href="{{ url_for('main.index') }}" class="btn btn-default btn-sm pull-right">
            <i class="fas fa-home"></i> Return to Home
        </a>
    </div>
{% else %}
<div class="container-fluid px-4">
    <div class="row">
        <div class="col-12">
            <div class="page-header">
                <h1>
                    <i class="fas fa-building"></i> {{ organization.name }}
                    <small class="text-muted">@{{ organization.domain }}</small>
                </h1>
            </div>

            <!-- Organization Stats -->
            <div class="row stats-row">
                <div class="col-md-3">
                    <div class="stat-box">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-number">{{ members|length }}</div>
                            <div class="stat-label">Members</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box">
                        <div class="stat-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-number">{{ pending_invites|length }}</div>
                            <div class="stat-label">Pending Invites</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Members Section -->
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        Members
                        <button class="btn btn-primary btn-sm invite-member-btn" data-toggle="modal" data-target="#inviteModal">
                            <i class="fas fa-user-plus"></i> Invite Member
                        </button>
                    </h3>
                </div>
                <div class="panel-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Joined</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for member in members %}
                                <tr>
                                    <td>{{ member.username }}</td>
                                    <td>{{ member.email }}</td>
                                    <td>
                                        <span class="label {% if member.role == 'admin' %}label-danger{% else %}label-info{% endif %}">
                                            {{ member.role|title }}
                                        </span>
                                    </td>
                                    <td>{{ member.created_at.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        {% if current_user.id != member.id and member.role != 'admin' %}
                                        <button class="btn btn-default btn-sm edit-role-btn" data-toggle="modal" 
                                                data-target="#editRoleModal" 
                                                data-userid="{{ member.id }}"
                                                data-username="{{ member.username }}"
                                                data-role="{{ member.role }}">
                                            <i class="fas fa-user-edit"></i> Edit Role
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Pending Invitations Section -->
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Pending Invitations</h3>
                </div>
                <div class="panel-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Sent</th>
                                    <th>Expires</th>
                                    <th>Token</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for invite in pending_invites %}
                                <tr {% if invite.is_expired() %}class="text-muted"{% endif %}>
                                    <td>{{ invite.email }}</td>
                                    <td>
                                        <span class="label {% if invite.is_admin_invite %}label-danger{% else %}label-info{% endif %}">
                                            {{ 'Admin' if invite.is_admin_invite else 'User' }}
                                        </span>
                                    </td>
                                    <td>{{ invite.created_at.strftime('%Y-%m-%d') }}</td>
                                    <td>{{ invite.expires_at.strftime('%Y-%m-%d') }}</td>
                                    <td><code>{{ invite.token }}</code></td>
                                    <td>
                                        <form action="{{ url_for('admin.cancel_invite', token=invite.token) }}" method="POST" style="display: inline;">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="fas fa-times"></i> Cancel
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center">No pending invites</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Current Subscription -->
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Current Subscription</h3>
                </div>
                <div class="panel-body">
                    {% if organization.subscription_plan %}
                        <div class="row">
                            <div class="col-md-6">
                                <h4>{{ organization.subscription_plan.name }} Plan</h4>
                                <p class="text-muted">{{ organization.subscription_plan.description }}</p>
                                <p><strong>Price:</strong> ${{ "%.2f"|format(organization.subscription_plan.price) }}/month</p>
                                <p><strong>Team Size Limit:</strong> {% if organization.subscription_plan.name == 'Enterprise' %}Unlimited{% else %}{{ organization.subscription_plan.team_size_limit }}{% endif %} members</p>
                                <p><strong>Current Team Size:</strong> {{ members|length }} members</p>
                                <p><strong>Remaining Seats:</strong> {% if organization.subscription_plan.name == 'Enterprise' %}Unlimited{% else %}{{ organization.subscription_plan.team_size_limit - members|length }}{% endif %} seats</p>
                                    
                                    <!-- Show Cancel button only for paid active subscriptions -->
                                    {% if organization.subscription_plan and organization.current_subscription and organization.current_subscription.status != 'cancelled' and organization.subscription_plan.price > 0 %}
                                        <div class="cancel-subscription-container mt-3">
                                            <button type="button" 
                                                    id="cancelSubscriptionBtn" 
                                                    class="btn btn-danger"
                                                    data-toggle="modal"
                                                    data-target="#cancelModal">
                                                Cancel Subscription
                                            </button>
                                        </div>
                                    {% endif %}

                                    {% if organization.current_subscription %}
                                        {% if organization.current_subscription.end_date %}
                                            <div class="mt-4 alert alert-warning subscription-end-alert" style="display: block !important;">
                                                <h5><i class="fas fa-info-circle"></i> Subscription Status</h5>
                                                <p style="margin-bottom: 5px;"><strong>Your subscription will end on {{ organization.current_subscription.end_date.strftime('%B %d, %Y') }}</strong></p>
                                                <p>You will continue to have access to all features until this date.</p>
                                                <p>After this date:</p>
                                                <ul>
                                                    <li>Your plan will automatically switch to the Free plan</li>
                                                    <li>Team size will be limited to the Free plan's limit</li>
                                                    <li>You can resubscribe at any time</li>
                                                </ul>
                                                <p class="small text-muted">Remaining time: {{ ((organization.current_subscription.end_date - current_time).days)|abs }} days</p>
                                            </div>
                                        {% else %}
                                            <div class="mt-4 alert alert-success subscription-status-alert subscription-end-alert" style="display: block !important;">
                                                <h5><i class="fas fa-check-circle"></i> Active Subscription</h5>
                                                <p style="margin-bottom: 5px;"><strong>Your {{ organization.subscription_plan.name }} plan is active</strong></p>
                                                {% if organization.subscription_plan.price > 0 %}
                                                    <p>Next billing date: {{ organization.current_subscription.next_billing_date.strftime('%B %d, %Y') }}</p>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    {% endif %}
                            </div>
                            <div class="col-md-6">
                                <h5>Features:</h5>
                                <ul class="list-unstyled">
                                    {% for feature in organization.subscription_plan.features %}
                                        <li><i class="fas fa-check text-success"></i> {{ feature }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    {% else %}
                        <p class="text-muted">No active subscription. Please select a plan below.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Available Plans -->
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Available Plans</h3>
                </div>
                <div class="panel-body">
                    <div class="row">
                        {% for plan in subscription_plans %}
                            <div class="col-md-4">
                                <div class="card h-100 {% if organization.subscription_plan and organization.subscription_plan.id == plan.id %}border-primary{% endif %}">
                                    <div class="card-header">
                                        <h5 class="mb-0">{{ plan.name }}</h5>
                                    </div>
                                    <div class="card-body">
                                        <h3 class="text-center mb-4">${{ "%.2f"|format(plan.price) }}<small class="text-muted">/month</small></h3>
                                        <p class="text-muted">{{ plan.description }}</p>
                                        <ul class="list-unstyled">
                                            {% for feature in plan.features %}
                                                <li><i class="fas fa-check text-success"></i> {{ feature }}</li>
                                            {% endfor %}
                                        </ul>
                                        <p><strong>Team Size:</strong> {% if plan.name == 'Enterprise' %}Unlimited{% else %}Up to {{ plan.team_size_limit }} members{% endif %}</p>
                                    </div>
                                    <div class="card-footer text-center">
                                        {% if plan.id != organization.subscription_plan.id %}
                                            {% if organization.current_subscription %}
                                                {% if organization.current_subscription.status == 'scheduled_downgrade' %}
                                                    {% if plan.id == organization.current_subscription.plan_id %}
                                                        <div class="alert alert-info mb-3 permanent-alert">
                                                            <i class="fas fa-info-circle"></i> Your subscription will be downgraded to {{ plan.name }} on {{ organization.current_subscription.end_date.strftime('%B %d, %Y') }}.
                                                        </div>
                                                        <button class="btn btn-secondary" disabled>Downgrade Scheduled</button>
                                                    {% else %}
                                                        <button class="btn btn-secondary" disabled>Available after current change</button>
                                                    {% endif %}
                                                {% elif plan.price < organization.subscription_plan.price %}
                                                    <!-- Downgrade - use direct form submission -->
                                                    <form action="{{ url_for('admin.switch_plan') }}" method="post" class="d-inline">
                                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                        <input type="hidden" name="plan_id" value="{{ plan.id }}">
                                                        <button type="submit" class="btn btn-primary" 
                                                                title="Switch to {{ plan.name }} plan at next billing cycle">
                                                            Switch to {{ plan.name }}
                                                        </button>
                                                    </form>
                                                {% else %}
                                                    <!-- Upgrade - use Stripe checkout -->
                                                    <div class="stripe-payment-container">
                                                        <button type="button" class="btn btn-primary subscribe-button" 
                                                                data-plan-name="{{ plan.name }}"
                                                                data-plan-price="{{ plan.price }}"
                                                                data-plan-id="{{ plan.id }}"
                                                                title="Upgrade to {{ plan.name }} plan">
                                                            Upgrade to {{ plan.name }}
                                                        </button>
                                                    </div>
                                                {% endif %}
                                            {% else %}
                                                <!-- New subscription - use Stripe checkout -->
                                                <div class="stripe-payment-container">
                                                    <button type="button" class="btn btn-primary subscribe-button" 
                                                            data-plan-name="{{ plan.name }}"
                                                            data-plan-price="{{ plan.price }}"
                                                            data-plan-id="{{ plan.id }}"
                                                            title="Subscribe to {{ plan.name }} plan">
                                                        Select {{ plan.name }} Plan
                                                    </button>
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            {% if organization.current_subscription.status == 'scheduled_downgrade' %}
                                                <div class="alert alert-info mb-3 permanent-alert">
                                                    <i class="fas fa-info-circle"></i> Your subscription will be downgraded on {{ organization.current_subscription.end_date.strftime('%B %d, %Y') }}.
                                                </div>
                                                <div class="btn-group">
                                                    <button class="btn btn-secondary" disabled>Current Plan</button>
                                                    <form action="{{ url_for('admin.cancel_downgrade') }}" method="post" class="d-inline">
                                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                        <button type="submit" class="btn btn-warning">
                                                            <i class="fas fa-undo"></i> Cancel Downgrade
                                                        </button>
                                                    </form>
                                                </div>
                                            {% else %}
                                                <button class="btn btn-secondary" disabled>Current Plan</button>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Invite Modal -->
            <div class="modal fade" id="inviteModal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">Invite New Member</h4>
                        </div>
                        <form action="{{ url_for('admin.invite_user') }}" method="POST" id="inviteForm">
                            <div class="modal-body">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <div class="form-group">
                                    <label for="emailPrefix">Email Address</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="emailPrefix" name="email_prefix" required>
                                        <span class="input-group-addon">@{{ organization.domain }}</span>
                                        <input type="hidden" name="email" id="fullEmail">
                                    </div>
                                    <div id="emailError" class="text-danger" style="display: none;"></div>
                                </div>
                                <div class="form-group">
                                    <label>Role</label>
                                    <div class="radio">
                                        <label>
                                            <input type="radio" name="role" value="user" checked>
                                            Regular User (can create and manage their own tickets)
                                        </label>
                                    </div>
                                    <div class="radio">
                                        <label>
                                            <input type="radio" name="role" value="staff">
                                            Staff (can manage all tickets)
                                        </label>
                                    </div>
                                    <div class="radio">
                                        <label>
                                            <input type="radio" name="role" value="admin">
                                            Admin (can manage organization and all features)
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary">Send Invitation</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Edit Role Modal -->
            <div class="modal fade" id="editRoleModal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">Edit Member Role</h4>
                        </div>
                        <form id="editRoleForm" method="POST">
                            <div class="modal-body">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <p>Update role for <strong id="editUsername"></strong></p>
                                <div class="form-group">
                                    <div class="radio">
                                        <label>
                                            <input type="radio" name="role" value="user" required>
                                            Regular User (can create and manage their own tickets)
                                        </label>
                                    </div>
                                    <div class="radio">
                                        <label>
                                            <input type="radio" name="role" value="staff" required>
                                            Staff (can manage all tickets)
                                        </label>
                                    </div>
                                    <div class="radio">
                                        <label>
                                            <input type="radio" name="role" value="admin" required>
                                            Admin (can manage organization and all features)
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </div>
                        </form>
                        
                <form action="" method="POST" id="removeMemberForm" style="display: inline;">
                    <div class="modal-footer" style="border-top: none;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to remove this member from the organization?');">
                            <i class="fas fa-user-minus"></i> Remove from Organization
                        </button>
                    </div>
                </form>
                        </div>
                    </div>
                </div>

                <!-- Reactivate Modal -->
                <div class="modal fade" id="reactivateModal" tabindex="-1" role="dialog">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                <h4 class="modal-title">Reactivate Subscription</h4>
                            </div>
                            <div class="modal-body">
                                <p>Are you sure you want to reactivate your subscription? You will be charged at your next billing date.</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-success" id="confirmReactivateBtn">
                                    <i class="fas fa-sync"></i> Reactivate
                                </button>
            </div>
        </div>
    </div>
</div>

                <!-- Cancel Modal -->
                <div class="modal fade" id="cancelModal" tabindex="-1" role="dialog">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                <h4 class="modal-title">Cancel Subscription</h4>
                            </div>
                            <div class="modal-body">
                                <p>Are you sure you want to cancel your subscription? Your subscription will remain active until the end of your current billing period.</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">No, Keep Subscription</button>
                                <button type="button" class="btn btn-danger" id="confirmCancelBtn">
                                    <i class="fas fa-times"></i> Yes, Cancel Subscription
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock app_content %}

{% block scripts %}
{{ super() }}
<script src="https://js.stripe.com/v3/"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle Stripe checkout buttons
    document.querySelectorAll('.subscribe-button').forEach(button => {
        button.addEventListener('click', async (e) => {
            e.preventDefault();
            const planId = button.dataset.planId;
            const planName = button.dataset.planName;
            const planPrice = button.dataset.planPrice;
            
            try {
                const response = await fetch('/admin/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        plan_id: planId,
                        plan_name: planName,
                        plan_price: planPrice
                    })
                });
                
                const session = await response.json();
                if (session.url) {
                    window.location.href = session.url;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('There was an error processing your request. Please try again.');
            }
        });
    });
});
</script>
{% endblock scripts %} 